name: Continuous Integration

on:
  push:
    branches:
      - '**'
      - '!dependabot/**'
  pull_request:
    branches:
      - '**'
      - '!main'
      - '!dependabot/**'
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}${{ github.event_name == 'workflow_dispatch' && '[dispatch]' || '' }}
  cancel-in-progress: true

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:
  build:
    name: "Build"
    uses: ./.github/workflows/continuous-integration.build.yml
    secrets: inherit

  code-ql:
    name: "QA"
    needs: build
    uses: ./.github/workflows/continuous-integration.code-ql.yml
    secrets: inherit
  test:
    name: "QA"
    needs: build
    uses: ./.github/workflows/continuous-integration.test.yml
    secrets: inherit
  sonar-cloud:
    name: "QA"
    needs: [test, code-ql]
    uses: ./.github/workflows/continuous-integration.sonar-cloud.yml
    secrets: inherit

  benchmark-core:
    name: "Benchmark"
    needs: [test, code-ql, sonar-cloud]
    uses: ./.github/workflows/continuous-integration.benchmark.yml
    secrets: inherit
    with:
      libraryName: 'Core'
      net_6_0-jobType: "Long"
      netcore_3_1-jobType: "Long"
  benchmark-xml:
    name: "Benchmark"
    needs: [test, code-ql, sonar-cloud]
    uses: ./.github/workflows/continuous-integration.benchmark.yml
    secrets: inherit
    with:
      libraryName: 'Xml'
  benchmark-json:
    name: "Benchmark"
    needs: [test, code-ql, sonar-cloud]
    uses: ./.github/workflows/continuous-integration.benchmark.yml
    secrets: inherit
    with:
      libraryName: 'Json'