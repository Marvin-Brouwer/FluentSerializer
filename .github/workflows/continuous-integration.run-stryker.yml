name: "Continuous integration - Run Stryker"
on:
  workflow_call:
    inputs:
      libraryName:
        description: 'The library to mutate'
        required: true
        type: string
    secrets:
      STRYKER_DASHBOARD_API_KEY:
        required: true

env:
  STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}

jobs:
  build-stryker:
    name: "Run on ${{ inputs.libraryName }}"
    runs-on: ubuntu-latest
    steps:
    ###
    # Checkout repository
    ###
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        lfs: true
    ###
    # ðŸ§° Install .Net SDKs
    #
    # Configure the pipeline to use the correct .Net sdk versions
    ###
    - name: ðŸ§° Install .Net SDKs
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x
    ###
    # ðŸ§° Setup .Net tools
    #
    # Register tools necessary to run the `test` pipeline-job
    ###
    - name: ðŸ§° Setup .NET tools
      run: |-
        dotnet tool install --global dotnet-stryker
    ###
    # ðŸ—ƒ Restore dependencies
    #
    # Fill the NuGet store with necessary libraries
    ###
    - name: ðŸ—ƒ Restore dependencies
      run: dotnet restore
    ###
    # ðŸ›  Build & Run
    #
    # Run Stryker.Net over codebase
    # debug verbosity because we don't have the progress reporter in pipelines
    ###
    - name: ðŸ›  Build & Run
      run: >-
        dotnet stryker
        --config-file "stryker-config.pipeline.json"
        --version "${{ github.ref }}"
        --break-at 40
        --dashboard-api-key "${{ secrets.STRYKER_DASHBOARD_API_KEY }}"
      working-directory: ${{github.workspace}}/src/FluentSerializer.${{ inputs.libraryName }}.Tests