name: "Continuous integration - Benchmark"
on:
  workflow_call:

defaults:
  run:
    shell: bash --noprofile --norc -euo pipefail {0}

jobs:
  benchmark:
    name: "${{ matrix.library.name }} - ${{ matrix.version.framework }} ${{ matrix.os }}"
    strategy:
      fail-fast: true
      max-parallel: 3
      matrix:
        library: [
          {name: "Core", reportPrefix: "core", jobType: "Long"},
          {name: "Json", reportPrefix: "json-serializer", jobType: "Default"},
          {name: "Xml", reportPrefix: "xml-serializer", jobType: "Default"}
        ]
        version: [
          {tag: "7.0.x", framework: "net7.0", report: "net_7_0"},
          {tag: "6.0.x", framework: "net6.0", report: "net_6_0"},
          {tag: "3.1.x", framework: "netcoreapp3.1", report: "netcoreapp_3_1"}
        ]
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - name: 🗃 Setup WSL
      if: runner.os == 'Windows'
      uses: Vampire/setup-wsl@v1
    ###
    # Checkout repository
    ###
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        lfs: true
    ###
    # 🧰 Install .Net SDKs
    #
    # Configure the pipeline to use the correct .Net sdk versions
    ###
    - name: 🧰 Install .Net SDKs
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ matrix.version.tag }}
    ###
    # ⏱ Benchmark FluentSerializer.${{ matrix.library.name }}
    #
    # Benchmark the code in the given library
    ###
    - name: ⏱ Benchmark FluentSerializer.${{ matrix.library.name }}
      shell: bash
      run: |-
        dotnet run --configuration "Release" --framework ${{ matrix.version.framework }} --jobType=${{matrix.library.jobType}}
      working-directory: ${{github.workspace}}/src/FluentSerializer.${{ matrix.library.name }}.Benchmark/
    ###
    # 🗃 Collect benchmark reports
    ###
    - name: 🗃 Collect benchmark reports
      if: ${{ always() }}
      run: |-
        dir=$(pwd);
        mkdir $dir/benchmark-results
        cd $dir/src/FluentSerializer.${{ matrix.library.name }}.Benchmark/BenchmarkDotNet.Artifacts/results
        mv ./${{ matrix.library.reportPrefix }}-*.md $dir/benchmark-results/
      working-directory: ${{github.workspace}}
    ###
    # 📈 Report benchmarks
    #
    # Publish benchmark results to job overview
    ###
    - name: 📈 Report benchmarks
      run: |-
        cat ./${{ matrix.library.reportPrefix }}-benchmark-${{ matrix.version.report }}-github.md >>$GITHUB_STEP_SUMMARY
      working-directory: ${{github.workspace}}/src/FluentSerializer.${{ matrix.library.name }}.Benchmark/BenchmarkDotNet.Artifacts/
    ###
    # 🗃 Publish 'benchmark-results' artifacts
    ###
    - name: 🗃 Publish 'benchmark-results' artifacts
      if: ${{ always() }}
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: ${{github.workspace}}/benchmark-results
        retention-days: 20