name: "Continuous integration - Benchmark"
on:
  workflow_call:
    inputs:
      libraryName:
        type: string
        required: true
      reportPrefix:
        type: string
        required: true
      jobTypePrimary:
        type: string
        required: true
      jobTypeSecondary:
        type: string
        required: false
        default: "Medium"

permissions:
  contents: read

env:
  DOTNET_VERBOSITY: "${{ (secrets.ACTIONS_STEP_DEBUG == true) && 'detailed' || 'minimal' }}"
  DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: true
  TERM: xterm-color

defaults:
  run:
    # Set the shell to wsl default, empty bash caused issues so using this:
    # https://github.com/Vampire/setup-wsl#wsl-shell-command
    shell: bash --noprofile --norc -euo pipefail {0}

jobs:
  benchmark:
    name: "${{ matrix.version.displayName }} - ${{ matrix.os.displayName }}"
    strategy:
      fail-fast: true
      matrix:
        # Benchmark for all applicable frameworks, only report the latest and only run the latest on primary setting
        version:  [
          {displayName: "net 9.0", sdkVersion: "9.0.x", framework: "net9.0", report: "net_9_0", jobType: "${{ inputs.jobTypePrimary }}", reportSummary: true },
          {displayName: "net 8.0", sdkVersion: "8.0.x", framework: "net8.0", report: "net_8_0", jobType: "${{ inputs.jobTypeSecondary }}" },
        ]
        # Benchmark for windows and linux, since this library probably is more applicable to server hosted solutions.
        os: [
          { name: windows-latest, displayName: windows, rid: "win-x64" },
          { name: ubuntu-latest, displayName: linux, rid: "linux-x64" }
        ]
        # Add a windows-only netframework benchmark, since that's only available on windows.
        include:
          # new ubuntu can't run netcore3.1 because of OpenSSL update, we tried all the fixes, none of them worked
          - version: {displayName: "netcoreapp 3.1", sdkVersion: "3.1.x", framework: "netcoreapp3.1", report: "netcoreapp_3_1", jobType: "${{ inputs.jobTypeSecondary }}" }
            os: { name: windows-latest, displayName: windows, rid: "win-x64" }
          - version: {displayName: "netcoreapp 3.1", sdkVersion: "3.1.x", framework: "netcoreapp3.1", report: "netcoreapp_3_1", jobType: "${{ inputs.jobTypeSecondary }}" }
            os: { name: ubuntu-20.04, displayName: linux, rid: "linux-x64" }
          # netframework only supports windows
          - version: {displayName: "netframework 4.8", sdkVersion: "3.1.x", framework: "net48", report: "netframework_4_8", jobType: "${{ inputs.jobTypeSecondary }}" }
            os: { name: windows-latest, displayName: windows, rid: "win-x64" }
    runs-on: ${{ matrix.os.name }}
    ###
    # ðŸ—ƒ Setup WSL
    #
    # Enable WSL when running on windows, this will help making the scripts more uniform
    ###
    steps:
    - name: ðŸ—ƒ Setup WSL
      if: runner.os == 'Windows'
      uses: Vampire/setup-wsl@v6
    ###
    # Checkout repository
    ###
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        lfs: true
    ###
    # ðŸ§° Install .Net SDKs
    #
    # Configure the pipeline to use the correct .Net sdk versions
    # Because we build the project multi-targeted, we need to install SDKs in the CSPROJ for it to compile.
    ###
    - name: ðŸ§° Install .Net SDK 9
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 9.0.x
    - name: ðŸ§° Install .Net SDK 8
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 8.0.x
    - name: ðŸ§° Install .Net SDK 3
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 3.1.x
    ###
    # â± Benchmark FluentSerializer.${{ matrix.library.name }}
    #
    # Benchmark the code in the given library
    # `shell: pwsh` because that'll ensure the native process is used when `dotnet run` is called.
    ###
    - name: â± Benchmark FluentSerializer.${{ inputs.libraryName }}
      shell: pwsh
      run: >-
        dotnet run
        --configuration "Release"
        --framework ${{ matrix.version.framework }}
        --runtime ${{ matrix.os.rid }}
        --no-self-contained
        --verbosity ${{ env.DOTNET_VERBOSITY }}
        --
        --os-displayName=${{ matrix.os.displayName }}
        --jobType=${{ matrix.version.jobType }}
        --quick-exit

        Write-Host "::remove-matcher owner=csc::"

        Write-Host "::remove-matcher owner=dotnet::"

      working-directory: ${{github.workspace}}/src/FluentSerializer.${{ inputs.libraryName }}.Benchmark/
    ###
    # ðŸ—ƒ Collect benchmark reports
    ###
    - name: ðŸ—ƒ Collect benchmark reports
      if: ${{ !cancelled() && success() }}
      run: |-
        dir=$(pwd);
        mkdir $dir/benchmark-results
        cd $dir/src/FluentSerializer.${{ inputs.libraryName }}.Benchmark/BenchmarkDotNet.Artifacts/results
        mv ./${{ inputs.reportPrefix }}-*.md $dir/benchmark-results/
      working-directory: ${{github.workspace}}
    ###
    # ðŸ“ˆ Report benchmarks
    #
    # Publish benchmark results to job overview
    ###
    - name: ðŸ“ˆ Report benchmarks
      if: ${{ !cancelled() && success() && matrix.version.reportSummary }}
      run: |-
        cat ./${{ inputs.reportPrefix }}-benchmark-${{ matrix.version.report }}-github.md >>$GITHUB_STEP_SUMMARY
      working-directory: ${{github.workspace}}/src/FluentSerializer.${{ inputs.libraryName }}.Benchmark/BenchmarkDotNet.Artifacts/
    ###
    # ðŸ—ƒ Publish 'benchmark-results' artifacts
    ###
    - name: ðŸ—ƒ Publish 'benchmark-results' artifacts
      if: ${{ !cancelled() && success() }}
      uses: actions/upload-artifact@v6
      with:
        name: benchmark-results-${{inputs.reportPrefix}}-${{matrix.version.framework}}-${{matrix.os.name}}
        path: ${{github.workspace}}/benchmark-results
        retention-days: 20