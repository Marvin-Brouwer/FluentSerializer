name: "Continuous integration - Benchmark"
on:
  workflow_call:
    inputs:
      libraryName:
        type: string
        required: true
      reportPrefix:
        type: string
        required: true
      jobTypePrimary:
        type: string
        required: true
      jobTypeSecondary:
        type: string
        required: false
        default: "Short"

defaults:
  run:
    # Set the shell to wsl default, however empty bash caused issues so using this:
    # https://github.com/Vampire/setup-wsl#wsl-shell-command
    shell: bash --noprofile --norc -euo pipefail {0}

jobs:
  benchmark:
    name: "${{ matrix.version.framework }} ${{ matrix.os.displayName }}"
    strategy:
      fail-fast: true
      matrix:
        # Benchmark for all applicable frameworks, only report the latest and only run the latest on primary setting
        version: [
          {tag: "7.0.x", framework: "net7.0", report: "net_7_0", jobType: "${{ inputs.jobTypePrimary }}", reportSummary: true },
          {tag: "6.0.x", framework: "net6.0", report: "net_6_0", jobType: "${{ inputs.jobTypeSecondary }}" },
          {tag: "3.1.x", framework: "netcoreapp3.1", report: "netcoreapp_3_1", jobType: "${{ inputs.jobTypeSecondary }}" }
        ]
        # Benchmark for windows and linux, since this library probably is more applicable to server hosted solutions.
        # ---
        # Temporarily removed `windows-latest`, because of provisioning issues
        # https://github.com/Marvin-Brouwer/FluentSerializer/issues/244
        os: [
          # { name: windows-latest, displayName: windows, rid: "win-x64" },
          { name: ubuntu-latest, displayName: linux, rid: "linux-x64" }
        ]
    runs-on: ${{ matrix.os.name }}
    ###
    # ðŸ—ƒ Setup WSL
    #
    # Enable WSL when running on windows, this will help making the scripts more uniform
    ###
    steps:
    - name: ðŸ—ƒ Setup WSL
      if: runner.os == 'Windows'
      uses: Vampire/setup-wsl@v1
    ###
    # Checkout repository
    ###
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        lfs: true
    ###
    # ðŸ§° Install .Net SDKs
    #
    # Configure the pipeline to use the correct .Net sdk versions
    ###
    - name: ðŸ§° Install .Net SDKs
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ matrix.version.tag }}
    ###
    # â± Benchmark FluentSerializer.${{ matrix.library.name }}
    #
    # Benchmark the code in the given library
    # `shell: pwsh` because that'll ensure the native process is used when `dotnet run` is called.
    ###
    - name: â± Benchmark FluentSerializer.${{ inputs.libraryName }}
      shell: pwsh
      run: >-
        dotnet run
        --configuration "Release"
        --framework ${{ matrix.version.framework }}
        --runtime ${{ matrix.os.rid }}
        --verbosity "detailed"
        --
        --jobType=${{ matrix.version.jobType }}
        --quick-exit

        Write-Host "::remove-matcher owner=csc::"

        Write-Host "::remove-matcher owner=dotnet::"

      working-directory: ${{github.workspace}}/src/FluentSerializer.${{ inputs.libraryName }}.Benchmark/
    ###
    # ðŸ—ƒ Collect benchmark reports
    ###
    - name: ðŸ—ƒ Collect benchmark reports
      if: ${{ !cancelled() && success() }}
      run: |-
        dir=$(pwd);
        mkdir $dir/benchmark-results
        cd $dir/src/FluentSerializer.${{ inputs.libraryName }}.Benchmark/BenchmarkDotNet.Artifacts/results
        mv ./${{ inputs.reportPrefix }}-*.md $dir/benchmark-results/
      working-directory: ${{github.workspace}}
    ###
    # ðŸ“ˆ Report benchmarks
    #
    # Publish benchmark results to job overview
    ###
    - name: ðŸ“ˆ Report benchmarks
      if: ${{ !cancelled() && success() && matrix.reportSummary }}
      run: |-
        cat ./${{ inputs.reportPrefix }}-benchmark-${{ matrix.version.report }}-github.md >>$GITHUB_STEP_SUMMARY
      working-directory: ${{github.workspace}}/src/FluentSerializer.${{ inputs.libraryName }}.Benchmark/BenchmarkDotNet.Artifacts/
    ###
    # ðŸ—ƒ Publish 'benchmark-results' artifacts
    ###
    - name: ðŸ—ƒ Publish 'benchmark-results' artifacts
      if: ${{ !cancelled() && success() }}
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: ${{github.workspace}}/benchmark-results
        retention-days: 20