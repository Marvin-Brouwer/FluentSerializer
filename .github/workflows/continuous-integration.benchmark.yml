name: "Continuous integration - Benchmarking"
on:
  workflow_call:
    inputs:
      libraryName:
        description: 'The library to benchmark'
        required: true
        type: string
      reportPrefix:
        description: 'The library to benchmark'
        required: true
        type: string
      net_7_0-jobType:
        description: 'The jobType for net 6 runtime'
        required: false
        default: "Default"
        type: string
      net_6_0-jobType:
        description: 'The jobType for net 6 runtime'
        required: false
        default: "Default"
        type: string
      netcore_3_1-jobType:
        description: 'The jobType for netcore 3.1 runtime'
        required: false
        default: "Default"
        type: string

jobs:
  benchmark:
    name: "Benchmark ${{ inputs.libraryName }}"
    runs-on: ubuntu-latest
    steps:
    ###
    # Checkout repository
    ###
    - name: Checkout repository
      uses: actions/checkout@v3
    ###
    # 🧰 Install .Net SDKs
    #
    # Configure the pipeline to use the correct .Net sdk versions
    ###
    - name: 🧰 Install .Net SDKs
      uses: actions/setup-dotnet@v3
      with:
        dotnet-quality: 'preview'
        dotnet-version: |
          3.1.x
          6.0.x
          7.0.x
    ###
    # 🗃 Restore dependencies
    #
    # Fill the NuGet store with necessary libraries
    ###
    - name: 🗃 Restore dependencies
      run: dotnet restore
    ###
    # 🗃 Restore 'library-binaries'
    ###
    - name: 🗃 Restore 'library-binaries'
      uses: actions/download-artifact@v3
      with:
        name: library-binaries
        path: ./src
    ###
    # 🗃 Restore 'benchmark-binaries'
    ###
    - name: 🗃 Restore 'benchmark-binaries'
      uses: actions/download-artifact@v3
      with:
        name: benchmark-binaries
        path: ./src
    ###
    # ⏱ Benchmark FluentSerializer.${{ inputs.libraryName }} (net7.0)
    #
    # Benchmark the code in the given library (in dotnet 7)
    ###
    - name: ⏱ Benchmark FluentSerializer.${{ inputs.libraryName }} (net7.0)
      run: |-
        sudo chmod +rwx ./*/FluentSerializer.${{ inputs.libraryName }}.Benchmark
        sudo ./net7.0/FluentSerializer.${{ inputs.libraryName }}.Benchmark --jobType=${{ inputs.net_7_0-jobType }}
      working-directory: ${{github.workspace}}/src/FluentSerializer.${{ inputs.libraryName }}.Benchmark/bin/Release
    ###
    # ⏱ Benchmark FluentSerializer.${{ inputs.libraryName }} (net6.0)
    #
    # Benchmark the code in the given library (in dotnet 6)
    ###
    - name: ⏱ Benchmark FluentSerializer.${{ inputs.libraryName }} (net6.0)
      run: |-
        sudo chmod +rwx ./*/FluentSerializer.${{ inputs.libraryName }}.Benchmark
        sudo ./net6.0/FluentSerializer.${{ inputs.libraryName }}.Benchmark --jobType=${{ inputs.net_6_0-jobType }}
      working-directory: ${{github.workspace}}/src/FluentSerializer.${{ inputs.libraryName }}.Benchmark/bin/Release
    ###
    # ⏱ Benchmark FluentSerializer.${{ inputs.libraryName }} (netcoreapp3.1)
    #
    # Benchmark the code in the given library (in dotnet core 3)
    ###
    - name: ⏱ Benchmark FluentSerializer.${{ inputs.libraryName }} (netcoreapp3.1)
      run: |-
        sudo chmod +rwx ./*/FluentSerializer.${{ inputs.libraryName }}.Benchmark
        sudo ./netcoreapp3.1/FluentSerializer.${{ inputs.libraryName }}.Benchmark --jobType=${{ inputs.netcore_3_1-jobType }}
      working-directory: ${{github.workspace}}/src/FluentSerializer.${{ inputs.libraryName }}.Benchmark/bin/Release
    ###
    # 🗃 Collect benchmark reports
    ###
    - name: 🗃 Collect benchmark reports
      if: ${{ always() }}
      run: |-
        sudo mkdir ${{github.workspace}}/benchmark-results
        cd ${{github.workspace}}/src/FluentSerializer.${{ inputs.libraryName }}.Benchmark/bin/Release/BenchmarkDotNet.Artifacts/results
        sudo mv ./${{ inputs.reportPrefix }}-*.md ${{github.workspace}}/benchmark-results/
      working-directory: ${{github.workspace}}
    ###
    # 📈 Report benchmarks
    #
    # Publish benchmark results to job overview
    ###
    - name: 📈 Report benchmarks
      run: |-
        cat ./${{ inputs.reportPrefix }}-benchmark-net_6_0-github.md >>$GITHUB_STEP_SUMMARY
        cat ./${{ inputs.reportPrefix }}-benchmark-netcoreapp_3_1-github.md >>$GITHUB_STEP_SUMMARY
      working-directory: ${{github.workspace}}/src/FluentSerializer.${{ inputs.libraryName }}.Benchmark/bin/Release/BenchmarkDotNet.Artifacts/
    ###
    # 🗃 Publish 'benchmark-results' artifacts
    ###
    - name: 🗃 Publish 'benchmark-results' artifacts
      if: ${{ always() }}
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results-${{ inputs.reportPrefix }}
        path: ${{github.workspace}}/benchmark-results
        retention-days: 20