name: "Continuous integration - Benchmark"
on:
  workflow_call:
    inputs:
      libraryName:
        type: string
        required: true
      reportPrefix:
        type: string
        required: true
      jobTypePrimary:
        type: string
        required: true
      jobTypeSecondary:
        type: string
        required: true


defaults:
  run:
    shell: bash --noprofile --norc -euo pipefail {0}

jobs:
  benchmark:
    name: "${{ matrix.version.framework }} ${{ matrix.os }}"
    strategy:
      fail-fast: true
      matrix:
        version: [
          {tag: "7.0.x", framework: "net7.0", report: "net_7_0", jobType: "${{ inputs.jobTypePrimary }}", reportSummary: true },
          {tag: "6.0.x", framework: "net6.0", report: "net_6_0", jobType: "${{ inputs.jobTypeSecondary }}" },
          {tag: "3.1.x", framework: "netcoreapp3.1", report: "netcoreapp_3_1", jobType: "${{ inputs.jobTypeSecondary }}" }
        ]
        # Removed `windows-latest` because of provisioning issues
        # https://github.com/Marvin-Brouwer/FluentSerializer/issues/244
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - name: 🗃 Setup WSL
      if: runner.os == 'Windows'
      uses: Vampire/setup-wsl@v1
    ###
    # Checkout repository
    ###
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        lfs: true
    ###
    # 🧰 Install .Net SDKs
    #
    # Configure the pipeline to use the correct .Net sdk versions
    ###
    - name: 🧰 Install .Net SDKs
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ matrix.version.tag }}
    ###
    # ⏱ Benchmark FluentSerializer.${{ matrix.library.name }}
    #
    # Benchmark the code in the given library
    ###
    - name: ⏱ Benchmark FluentSerializer.${{ inputs.libraryName }}
      shell: bash
      run: >-
        dotnet run
        --configuration "Release"
        --framework ${{ matrix.version.framework }}
        --jobType=${{ matrix.version.jobType }}
        --quick-exit

        echo "::remove-matcher owner=csc::"

        echo "::remove-matcher owner=dotnet::"

      working-directory: ${{github.workspace}}/src/FluentSerializer.${{ inputs.libraryName }}.Benchmark/
    ###
    # 🗃 Collect benchmark reports
    ###
    - name: 🗃 Collect benchmark reports
      if: ${{ !cancelled() }}
      run: |-
        dir=$(pwd);
        mkdir $dir/benchmark-results
        cd $dir/src/FluentSerializer.${{ inputs.libraryName }}.Benchmark/BenchmarkDotNet.Artifacts/results
        mv ./${{ inputs.reportPrefix }}-*.md $dir/benchmark-results/
      working-directory: ${{github.workspace}}
    ###
    # 📈 Report benchmarks
    #
    # Publish benchmark results to job overview
    ###
    - name: 📈 Report benchmarks
      if: ${{ !cancelled() && matrix.reportSummary }}
      run: |-
        cat ./${{ inputs.reportPrefix }}-benchmark-${{ matrix.version.report }}-github.md >>$GITHUB_STEP_SUMMARY
      working-directory: ${{github.workspace}}/src/FluentSerializer.${{ inputs.libraryName }}.Benchmark/BenchmarkDotNet.Artifacts/
    ###
    # 🗃 Publish 'benchmark-results' artifacts
    ###
    - name: 🗃 Publish 'benchmark-results' artifacts
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: ${{github.workspace}}/benchmark-results
        retention-days: 20